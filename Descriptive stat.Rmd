---
title: "Multi-state Modelling"
author: "Septiara Putri"
date: "2024-08-30"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Description 
This is a descriptive statistic and multistate model analysis using CPRD Aurum data.
State transition model (STM) consists of several states representing cardiometabolic disease (CMD) progression. The structure of model is published at:  https://bmchealthservres.biomedcentral.com/articles/10.1186/s12913-024-11559-y. States: disease free, type 2 diabetes (T2DM), Stroke, MI, Post-stroke, Post-MI, Deat
Multistate model extends survival analysis to scenarios where individuals or units can transition between multiple states over time. Each state transition is treated as a distinct event


```{r set the working directory, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
setwd("/Users/septiaraputri/Desktop/RParquet/PrepareAurumData")
msmData<-read.csv("/Users/septiaraputri/Desktop/RParquet/PrepareAurumData/wideTransitionTableSubset.csv")
```

```{r load library, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
library(cmprsk)
library(data.table)
library(dplyr)
library(kableExtra)
library(knitr)
library(ggplot2)
library(mstate)
library(patchwork)
library(psych)
library(tidyr)
library(survminer)
```

# Non-modifiable risks factors
```{r desc stat AGE, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
#Age
msmData <-msmData %>%
  mutate(ageGroup = cut(age, breaks =c(0, 18, 30, 45, 60, 75, Inf),
                         labels = c("<18","18-29","30-44","45-59","60-74", "≥75"),
                         right=FALSE))

descAge <-msmData %>%
  group_by(ageGroup, gender) %>%
  summarise(
    count = n(),
    percentage = round((n()/nrow(msmData))*100,2),
    meanAge = round(mean (age, na.rm=TRUE), 2),
    medianAge = round(median(age, na.rm=TRUE), 2),
    sdAge = round(sd(age, na.rm = TRUE), 2),
    Q1_Age = round(quantile(age, 0.25, na.rm = TRUE), 2),   # First quartile (Q1)
    Q3_Age = round(quantile(age, 0.75, na.rm = TRUE), 2),   # Third quartile (Q3)
    iqrAge = round(IQR(age, na.rm = TRUE), 2),              # Interquartile Range (IQR)
    .groups = 'drop'
    
  ) 
overallAge <- msmData %>%
  summarise(
    ageGroup = "Overall",
    gender = "All",
    count = n(),
    percentage = 100,
    meanAge = round(mean(age, na.rm = TRUE), 2),
    medianAge = round(median(age, na.rm = TRUE), 2),
    sdAge = round(sd(age, na.rm = TRUE), 2),
    Q1_Age = round(quantile(age, 0.25, na.rm = TRUE), 2),
    Q3_Age = round(quantile(age, 0.75, na.rm = TRUE), 2),
    iqrAge = round(IQR(age, na.rm = TRUE), 2)
  )

# Combine grouped and overall summaries
descAge <- bind_rows(descAge, overallAge)

#print table
print(descAge)
#chart: age
ggplot(descAge, aes(x = ageGroup, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Age distribution by gender (%)",
       x = "Age group",
       y = "Percentage",
       fill = "Gender") +
  theme_minimal() +
  theme(plot.title = element_text(hjust=0.5,margin = margin(b = 30)))
```

```{r desc stat GENDER, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
#General summary statisti
msmData$gender<-as.factor(msmData$gender)
descGender <-msmData %>%
  group_by(gender) %>%
  summarise(
    count = n(),
    percentage = round((n()/nrow(msmData))*100,2),
)

#print table
print(descGender)
```

```{r desc stat IMD, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
descDeprivation <- msmData %>%
  group_by(deprivationIndex, gender) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(msmData)) * 100, 2),
  )

# print table
print(descDeprivation)

# chart: IMD, 1=least deprived and 5=most deprived
ggplot(descDeprivation, aes(x = deprivationIndex, y = percentage, fill = gender)) +
  geom_bar(stat = "identity") +
  labs(title = "Distribution of deprivation level (%)", x = "Deprivation level", y = "Percentage (%)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust=0.5,margin = margin(b = 30))) 
```

```{r desc stat ETHNICITY, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
descEthnicity <- msmData %>%
  group_by(ethnicity = addNA(as.factor(ethnicity))) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(msmData)) * 100, 2),
)
totalCount <- nrow(msmData)
totalPercentage <- round((totalCount / totalCount) * 100, 2)  
totalRow <- tibble(
  ethnicity = "Total",
  count = totalCount,
  percentage = totalPercentage
)
descEthnicity <- bind_rows(descEthnicity, totalRow)

#print table
print(descEthnicity)

#chart: ethnicity
ggplot(descEthnicity_filtered, aes(x = ethnicity, y = percentage, fill = ethnicity)) +
  geom_bar(stat = "identity") +
  labs(title = "Distribution of ethnicity (%)", x = "Ethnicity", y = "Percentage (%)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust=0.5,margin = margin(b = 30))) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r desc stat ALCOHOL, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
#Alcohol level
#Level 0>>>0 unit/week, non-drinker)
#Level 0>>>up to 14 unit/week, low consumption)
#Level 0>>>5-35/week, moderate consumption)
#Level 0>>>>35 unit/week, high consumption)

descAlcohol <- msmData %>%
  group_by(alcoholStatus, gender) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(msmData)) * 100, 2),  
  )

#print table
print(descAlcohol)

#chart: alcohol status
ggplot(descAlcohol %>% filter(!is.na(alcoholStatus)), aes(x = alcoholStatus, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Alcohol Consumption Levels (%)",
       x = "Alcohol Consumption Level",
       y = "Percentage (%)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, margin = margin(b = 30)),
        axis.text.x = element_text(angle = 45, hjust = 1)) 
```

```{r desc stat SMOKING, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
descSmoking <- msmData %>%
  group_by(latestSmokingStatus, gender) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(msmData)) * 100, 2)   # Removed the trailing comma
  )

# Print table
print(descSmoking)

# Chart: smoking status
ggplot(descSmoking, aes(x = latestSmokingStatus, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Latest smoking status (%)", 
    x = "Smoking status", 
    y = "Percentage (%)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 30)),
    axis.text.x = element_text(hjust = 0.5)
  )
```

```{r desc stat FAMILY HISTORY, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
longFH<- msmData %>%
  pivot_longer(cols=c(cvdFH, diabetesFH),
  names_to = "FamilyHistory",
  values_to = "status")

descFH<-longFH %>%
  group_by(FamilyHistory, status= addNA(as.factor(status)), gender) %>%
  summarise(
    count = n(),  
    percentage = round((n() / nrow(msmData)) * 100, 2)
)

#print table
print(descFH)

#only the confirmed FH 
descFH_filtered <- descFH %>%
  filter(status == "TRUE")

# chart: family history
ggplot(descFH_filtered, aes(x = FamilyHistory, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +  
  labs(title = "Disease family history by gender (%)", 
       x = "Family History Status", 
       y = "Percentage (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(hjust = 1),  
        legend.position = "right",  
        plot.title = element_text(hjust = 0.5, margin = margin(b = 30)),  
        plot.margin = margin(b = 30, t = 20, r = 20, l = 20))  
```

```{r desc stat PREVIOUS DIAGNOSIS STATUS, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
longPDS<- msmData %>%
  pivot_longer(
    cols=c(atrialFib, hyperlipidaemia, hypertension),
    names_to = "previousDiagnosis",
    values_to = "status"
    )
 
descPDS <- longPDS %>%
  group_by(previousDiagnosis, status = as.factor(status), gender) %>%
  summarise(
    count = n(),  
    percentage = round((n() / nrow(msmData)) * 100, 2),
    .groups = 'drop'
  )

#print table
print(descPDS)
# only confirmed diagnosis
descPDS_filtered <- descPDS %>%
  filter(status == "TRUE")
#chart: previous diagnosi
ggplot(descPDS, aes(x = previousDiagnosis, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +  
  facet_wrap(~ gender) +  
  labs(title = "Disease status by gender(%)", 
       x = "Disease status", 
       y = "Percentage (%)") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(hjust = 0.5),  
    legend.position = "right", 
    plot.title = element_text(hjust = 0.5, margin = margin(b = 30)),
    plot.margin = margin(b =30, t = 20, r = 20, l = 20)
  )
```


#Modifiable risk factors
```{r desc stat BMI, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
set.seed(123)
dataBMI<- msmData %>%
  mutate(
   numBMI=case_when(
    bmi== "less.than.18.5"~ "<18.5", #underweight
    bmi== "18.5.to.25" ~ "18.5-24.9",#normal weight
    bmi== "25.to.30" ~ "25-29.9",    #moderate
    bmi== "greater.than.30"~ "≥30",  #obese
    TRUE ~ bmi
  ),
 bmiNumeric = case_when(
    bmi == "less.than.18.5" ~ runif(n(), min = 16, max = 18.4),
    bmi == "18.5.to.25" ~ runif(n(), min = 18.5, max = 25),
    bmi == "25.to.30" ~ runif(n(), min = 25, max = 30),
    bmi == "greater.than.30" ~ runif(n(), min = 30, max = 40),
    TRUE ~ as.numeric(bmi)
  )
)
  
descBMI <- dataBMI %>%
  group_by(numBMI, gender) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(dataBMI)) * 100, 2),
    meanBMI = round(mean(bmiNumeric , na.rm = TRUE), 2),
    medianBMI = round(median(bmiNumeric, na.rm = TRUE), 2),
    sdBMI = round(sd(bmiNumeric , na.rm = TRUE), 2),
    Q1_BMI = round(quantile(bmiNumeric, 0.25, na.rm = TRUE), 2),   # First quartile (Q1)
    Q3_BMI = round(quantile(bmiNumeric, 0.75, na.rm = TRUE), 2),   # Third quartile (Q3)
    iqrBMI = round(IQR(bmiNumeric, na.rm = TRUE), 2),              # Interquartile Range (IQR)
    .groups = 'drop'
  )

overallBMI <- dataBMI %>%
  summarise(
    numBMI = "Overall",             
    gender = "All",                  
    count = n(),
    percentage = 100,               
    meanBMI = round(mean(bmiNumeric , na.rm = TRUE), 2),
    medianBMI = round(median(bmiNumeric, na.rm = TRUE), 2),
    sdBMI = round(sd(bmiNumeric, na.rm = TRUE), 2),
    Q1_BMI = round(quantile(bmiNumeric, 0.25, na.rm = TRUE), 2),
    Q3_BMI = round(quantile(bmiNumeric, 0.75, na.rm = TRUE), 2),
    iqrBMI = round(IQR(bmiNumeric, na.rm = TRUE), 2)
  )
descBMI <- bind_rows(descBMI, overallBMI)

#print table
print(descBMI)

#chart: BMI
# Set the correct order for BMI categories
descBMI_filtered <- descBMI %>%
  filter(numBMI != "Overall") %>%
  mutate(numBMI = factor(numBMI, levels = c("<18.5", "18.5-24.9", "25-29.9", "≥30")))

# Plot with the ordered BMI categories
ggplot(descBMI_filtered, aes(x = numBMI, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "BMI Categories by gender (%)",
    x = "BMI Category (kg/m2)",
    y = "Percentage (%)",
    fill = "Gender"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(hjust = 0.5),  
    legend.position = "right", 
    plot.title = element_text(hjust = 0.5, margin = margin(b = 30)),
    plot.margin = margin(b = 30, t = 20, r = 20, l = 20)
  )
```

```{r desc stat HDL, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
set.seed(123)
dataHDL <- msmData %>%
  mutate(
    numHDL = case_when(
      hdl == "less.than.1.03" ~ "<1.03",     #low >>> higher risk of CMD
      hdl == "1.03.to.1.55" ~ "1.03-1.54",   #borderline >>> adequate
      hdl == "greater.than.1.55" ~ "≥1.55",  #high >>> protective
      TRUE ~ hdl
    ),
    # Generate uniform values within each HDL range
    hdlNumeric = case_when(
      hdl == "less.than.1.03" ~ runif(n(), min = 0.8, max = 1.03),
      hdl == "1.03.to.1.55" ~ runif(n(), min = 1.03, max = 1.54),
      hdl == "greater.than.1.55" ~ runif(n(), min = 1.55, max = 2.2),
      TRUE ~ as.numeric(hdl)
    )
  )
descHDL <- dataHDL %>%
  group_by(numHDL, gender) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(dataHDL)) * 100, 2),
    meanHDL = round(mean(hdlNumeric, na.rm = TRUE), 2),
    medianHDL = round(median(hdlNumeric, na.rm = TRUE), 2),
    sdHDL = round(sd(hdlNumeric, na.rm = TRUE), 2),
    Q1_HDL = round(quantile(hdlNumeric, 0.25, na.rm = TRUE), 2),   # First quartile (Q1)
    Q3_HDL = round(quantile(hdlNumeric, 0.75, na.rm = TRUE), 2),   # Third quartile (Q3)
    iqrHDL = round(IQR(hdlNumeric, na.rm = TRUE), 2),              # Interquartile Range (IQR)
    .groups = 'drop'
  )
overallHDL <- dataHDL %>%
  summarise(
    numHDL = "Overall",             
    gender = "All",                  
    count = n(),
    percentage = 100,               
    meanHDL = round(mean(hdlNumeric  , na.rm = TRUE), 2),
    medianHDL = round(median(hdlNumeric , na.rm = TRUE), 2),
    sdHDL = round(sd(hdlNumeric , na.rm = TRUE), 2),
    Q1_HDL = round(quantile(hdlNumeric,0.25, na.rm = TRUE), 2),
    Q3_HDL = round(quantile(hdlNumeric,0.75, na.rm = TRUE), 2),
    iqrHDL = round(IQR(hdlNumeric , na.rm = TRUE), 2)
  )

descHDL <- bind_rows(descHDL, overallHDL)

# Print table
print(descHDL)

#chart: HDL
descHDL_filtered <- descHDL %>%
  filter(numHDL != "Overall") %>%
  mutate(numHDL = factor(numHDL, levels = c("<1.03", "1.03-1.54", "≥1.55")))

ggplot(descHDL_filtered, aes(x = numHDL, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "HDL Categories by gender (%)",
    x = "HDL level (mmol/l)",
    y = "Percentage (%)",
    fill = "Gender"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(hjust = 0.5),  
    legend.position = "right", 
    plot.title = element_text(hjust = 0.5, margin = margin(b = 30)),
    plot.margin = margin(b = 30, t = 20, r = 20, l = 20)
  )
```

```{r desc stat LDL, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
set.seed(123)
dataLDL<- msmData %>%
  mutate(numLDL=case_when(
    ldl== "less.than.2.6"~ "<2.6",     #optimal/low-risk >>> low-risk level
    ldl== "2.6.to.3.4" ~ "2.6-3.3",    #above optimal >>> slightly increased
    ldl== "3.4.to.4.0" ~ "3.4-3.9",    #borderline high >>> moderate
    ldl== "4.0.to.4.9" ~ "4.0-4.9",    #high >>> high
    ldl== "greater.than.4.9" ~ "≥4.9", #very high >>> significant
    TRUE ~ ldl
  ),
  ldlNumeric=case_when(
    ldl== "less.than.2.6"~ runif(n(), min=2.0, max=2.59), 
    ldl== "2.6.to.3.4" ~ runif(n(), min=2.6, max=3.39),
    ldl== "3.4.to.4.0" ~ runif(n(), min=3.4, max=3.99),
    ldl== "4.0.to.4.9" ~ runif(n(), min=4.0, max=4.9),
    ldl== "greater.than.4.9" ~ runif(n(), min=4.9, max=5.5),
    TRUE ~ as.numeric(ldl)
  )
)

descLDL <- dataLDL %>%
  group_by(numLDL, gender) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(msmData)) * 100, 2),
    meanLDL = round(mean(ldlNumeric, na.rm = TRUE), 2),
    medianLDL = round(median(ldlNumeric, na.rm = TRUE), 2),
    sdLDL = round(sd(ldlNumeric, na.rm = TRUE), 2),
    Q1_LDL = round(quantile(ldlNumeric, 0.25, na.rm = TRUE), 2),   # First quartile (Q1)
    Q3_LDL = round(quantile(ldlNumeric, 0.75, na.rm = TRUE), 2),   # Third quartile (Q3)
    iqrLDL = round(IQR(ldlNumeric, na.rm = TRUE), 2),    
    .groups = 'drop'
  )
overallLDL <- dataLDL %>%
  summarise(
    numLDL = "Overall",             
    gender = "All",                  
    count = n(),
    percentage = 100,               
    meanLDL = round(mean(ldlNumeric  , na.rm = TRUE), 2),
    medianLDL = round(median(ldlNumeric, na.rm = TRUE), 2),
    sdLDL = round(sd(ldlNumeric , na.rm = TRUE), 2),
    Q1_LDL = round(quantile(ldlNumeric,0.25, na.rm = TRUE), 2),
    Q3_LDL = round(quantile(ldlNumeric,0.75, na.rm = TRUE), 2),
    iqrLDL = round(IQR(ldlNumeric , na.rm = TRUE), 2)
  )

descLDL <- bind_rows(descLDL, overallLDL)

# Print table
print(descLDL)

#chart: LDL
descLDL_filtered <- descLDL %>%
  filter(numLDL != "Overall") %>%
  mutate(numLDL = factor(numLDL, levels = c("<2.6", "2.6-3.3", "3.4-3.9", "4.0-4.9","≥4.9")))

ggplot(descLDL_filtered, aes(x = numLDL, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "LDL Categories by gender (%)",
    x = "LDL level (mmol/l)",
    y = "Percentage (%)",
    fill = "Gender"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(hjust = 0.5),  
    legend.position = "right", 
    plot.title = element_text(hjust = 0.5, margin = margin(b = 30)),
    plot.margin = margin(b = 30, t = 20, r = 20, l = 20)
  )
```

```{r desc stat SBP, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
set.seed(123)
dataSBP<- msmData %>%
  mutate(
   numSBP=case_when(
    sbp== "less.than.120"~ "<120",       #normal
    sbp== "120.to.140" ~ "120-140",      #elevated
    sbp== "greater.than.140" ~ "≥140",    #hypertension
    TRUE ~ sbp
  ),
 sbpNumeric = case_when(
    sbp == "less.than.120" ~ runif(n(), min =70, max = 120),
    sbp == "120.to.140" ~ runif(n(), min = 120, max = 140),
    sbp == "greater.than.140" ~ runif(n(), min = 140, max = 180),
    TRUE ~ as.numeric(sbp)
  )
)
  
descSBP <- dataSBP %>%
  group_by(numSBP, gender) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(dataBMI)) * 100, 2),
    meanSBP = round(mean( sbpNumeric , na.rm = TRUE), 2),
    medianSBP = round(median(sbpNumeric, na.rm = TRUE), 2),
    sdSBP = round(sd(sbpNumeric , na.rm = TRUE), 2),
    Q1_SBP = round(quantile(sbpNumeric, 0.25, na.rm = TRUE), 2),   # First quartile (Q1)
    Q3_SBP = round(quantile(sbpNumeric, 0.75, na.rm = TRUE), 2),   # Third quartile (Q3)
    iqrSBP = round(IQR(sbpNumeric, na.rm = TRUE), 2), 
    .groups = 'drop'
  )

overallSBP <- dataSBP %>%
  summarise(
    numSBP = "Overall",             
    gender = "All",                  
    count = n(),
    percentage = 100,               
    meanSBP = round(mean(sbpNumeric , na.rm = TRUE), 2),
    medianSBP = round(median(sbpNumeric, na.rm = TRUE), 2),
    sdSBP = round(sd(sbpNumeric, na.rm = TRUE), 2),
    Q1_SBP = round(quantile(sbpNumeric, 0.25, na.rm = TRUE), 2),
    Q3_SBP = round(quantile(sbpNumeric, 0.75, na.rm = TRUE), 2),   
    iqrSBP = round(IQR(sbpNumeric, na.rm = TRUE), 2),  
  )
descSBP <- bind_rows(descSBP, overallSBP)

#print table
print(descSBP)

#chart: SBP
descSBP_filtered <- descSBP %>%
  filter(numSBP != "Overall") %>%
  mutate(numSBP = factor(numSBP, levels = c("<120", "120-140", "≥140")))

ggplot(descSBP_filtered, aes(x = numSBP, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "SBP level by gender (%)",
    x = "SBP level (mmHg)",
    y = "Percentage (%)",
    fill = "Gender"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(hjust = 0.5),  
    legend.position = "right", 
    plot.title = element_text(hjust = 0.5, margin = margin(b = 30)),
    plot.margin = margin(b = 30, t = 20, r = 20, l = 20)
  )
```

```{r desc stat DBP, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
set.seed(123)
dataDBP<- msmData %>%
  mutate(
   numDBP=case_when(
    dbp== "less.than.80"~ "<80",       #normal
    dbp== "80.to.90" ~ "80-90",        #elevated
    dbp== "greater.than.90" ~ "≥90",   #hypertension
    TRUE ~ dbp
  ),
 dbpNumeric = case_when(
    dbp == "less.than.80" ~ runif(n(), min = 60, max = 80),
    dbp == "80.to.90" ~ runif(n(), min = 80, max = 90),
    dbp == "greater.than.90" ~ runif(n(), min = 90, max = 120),
    TRUE ~ as.numeric(dbp)
  )
)
  
descDBP <- dataDBP %>%
  group_by(numDBP, gender) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(dataDBP)) * 100, 2),
    meanDBP = round(mean( dbpNumeric , na.rm = TRUE), 2),
    medianDBP = round(median(dbpNumeric, na.rm = TRUE), 2),
    sdDBP = round(sd(dbpNumeric , na.rm = TRUE), 2),
    Q1_DBP = round(quantile(dbpNumeric, 0.25, na.rm = TRUE), 2),
    Q3_DBP = round(quantile(dbpNumeric, 0.75, na.rm = TRUE), 2),   
    iqrDBP = round(IQR(dbpNumeric, na.rm = TRUE), 2), 
    .groups = 'drop'
  )

overallDBP <- dataDBP %>%
  summarise(
    numDBP = "Overall",             
    gender = "All",                  
    count = n(),
    percentage = 100,               
    meanDBP = round(mean(dbpNumeric , na.rm = TRUE), 2),
    medianDBP = round(median(dbpNumeric, na.rm = TRUE), 2),
    sdDBP = round(sd(dbpNumeric, na.rm = TRUE), 2),
    Q1_DBP = round(quantile(dbpNumeric, 0.25, na.rm = TRUE), 2),
    Q3_DBP = round(quantile(dbpNumeric, 0.75, na.rm = TRUE), 2),   
    iqrDBP = round(IQR(dbpNumeric, na.rm = TRUE), 2), 
  )
descDBP <- bind_rows(descDBP, overallDBP)

#print table
print(descDBP)

#chart: SBP
descDBP_filtered <- descDBP %>%
  filter(numDBP != "Overall") %>%
  mutate(numDBP = factor(numDBP, levels = c("<80", "80-90", "≥90")))

ggplot(descDBP_filtered, aes(x = numDBP, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "DBP categories by gender (%)",
    x = "DBP level (mmHg)",
    y = "Percentage (%)",
    fill = "Gender"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(hjust = 0.5),  
    legend.position = "right", 
    plot.title = element_text(hjust = 0.5, margin = margin(b = 30)),
    plot.margin = margin(b = 30, t = 20, r = 20, l = 20)
  )
```

```{r desc stat TRIGLYCERIDES, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
set.seed(123)
dataTriglycerides<- msmData %>%
  mutate(
   numTriglycerides=case_when(
    triglycerides== "less.than.1.7"~ "<1.7",       #low risk
    triglycerides== "1.7.to.2.3" ~ "1.7-2.2",      #borderline high
    triglycerides== "2.3.to.5.6" ~ "2.3-5.6",      #high
    triglycerides== "greater.than.5.6" ~ "≥5.6",   #very high
    TRUE ~ triglycerides
  ),
triglyceridesNumeric = case_when(
    triglycerides == "less.than.1.7" ~ runif(n(), min = 1.5, max = 1.69),
    triglycerides== "1.7.to.2.3" ~ runif(n(), min = 1.7, max = 2.3),
    triglycerides== "2.3.to.5.6"~ runif(n(), min = 2.3, max =5.6),
    triglycerides== "greater.than.5.6" ~ runif(n(), min = 5.6, max = 8),
    TRUE ~ as.numeric(triglycerides)
  )
)
  
descTriglycerides<- dataTriglycerides %>%
  group_by(numTriglycerides, gender) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(dataTriglycerides)) * 100, 2),
    meanTriglycerides = round(mean(triglyceridesNumeric , na.rm = TRUE), 2),
    medianTriglycerides = round(median(triglyceridesNumeric, na.rm = TRUE), 2),
    sdTriglycerides= round(sd(triglyceridesNumeric , na.rm = TRUE), 2),
    Q1_Triglycerides = round(quantile(triglyceridesNumeric, 0.25, na.rm = TRUE), 2),
    Q3_Triglycerides = round(quantile(triglyceridesNumeric, 0.75, na.rm = TRUE), 2),   
    iqrTriglycerides = round(IQR(triglyceridesNumeric, na.rm = TRUE), 2), 
    .groups = 'drop'
  )

overallTriglycerides<- dataTriglycerides %>%
  summarise(
    numTriglycerides= "Overall",             
    gender = "All",                  
    count = n(),
    percentage = 100,               
    meanTriglycerides = round(mean(triglyceridesNumeric , na.rm = TRUE), 2),
    medianTriglycerides = round(median(triglyceridesNumeric, na.rm = TRUE), 2),
    sdTriglycerides = round(sd(triglyceridesNumeric, na.rm = TRUE), 2),
    Q1_Triglycerides = round(quantile(triglyceridesNumeric, 0.25, na.rm = TRUE), 2),
    Q3_Triglycerides = round(quantile(triglyceridesNumeric, 0.75, na.rm = TRUE), 2),   
    iqrTriglycerides = round(IQR(triglyceridesNumeric, na.rm = TRUE), 2), 
  )
descTriglycerides <- bind_rows(descTriglycerides, overallTriglycerides)

#print table
print(descTriglycerides)

#chart: SBP
descTriglycerides_filtered <- descTriglycerides %>%
  filter(numTriglycerides != "Overall") %>%
  mutate(numTriglycerides = factor(numTriglycerides, levels = c("<1.7", "1.7-2.2", "2.3-5.6","≥5.6")))

ggplot(descTriglycerides_filtered, aes(x = numTriglycerides, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Triglycerides categories by gender (%)",
    x = "Triglycerides level (mmol/l)",
    y = "Percentage (%)",
    fill = "Gender"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(hjust = 0.5),  
    legend.position = "right", 
    plot.title = element_text(hjust = 0.5, margin = margin(b = 30)),
    plot.margin = margin(b = 30, t = 20, r = 20, l = 20)
  )
```

```{r desc stat TOTAL CHOLESTEROL, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
set.seed(123)
dataCholesterol <- msmData %>%
  mutate(
    numCholesterol = case_when(
      cholesterol == "less.than.5.0" ~ "<5.0",         # Low risk
      cholesterol == "5.0.to.5.5" ~ "5.0-5.5",         # Borderline high
      cholesterol == "5.5.to.6.0" ~ "5.6-6.0",         # High
      cholesterol == "greater.than.6.0" ~ "≥6.0",      # Very high
      TRUE ~ cholesterol
    ),
    cholesterolNumeric = case_when(
      cholesterol == "less.than.5.0" ~ runif(n(), min = 4, max = 5),
      cholesterol == "5.0.to.5.5" ~ runif(n(), min = 5, max = 5.5),
      cholesterol == "5.5.to.6.0" ~ runif(n(), min = 5.6, max = 6),
      cholesterol == "greater.than.6.0" ~ runif(n(), min = 6, max = 8),
      TRUE ~ as.numeric(cholesterol)
    )
  )

descCholesterol <- dataCholesterol %>%
  group_by(numCholesterol, gender) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(dataCholesterol)) * 100, 2),
    meanCholesterol = round(mean(cholesterolNumeric, na.rm = TRUE), 2),
    medianCholesterol = round(median(cholesterolNumeric, na.rm = TRUE), 2),
    sdCholesterol = round(sd(cholesterolNumeric, na.rm = TRUE), 2),
    Q1_Cholesterol = round(quantile(cholesterolNumeric, 0.25, na.rm = TRUE), 2),
    Q3_Cholesterol = round(quantile(cholesterolNumeric, 0.75, na.rm = TRUE), 2),
    iqrCholesterol = round(IQR(cholesterolNumeric, na.rm = TRUE), 2),
    .groups = 'drop'
  )

overallCholesterol <- dataCholesterol %>%
  summarise(
    numCholesterol = "Overall",             
    gender = "All",                   
    count = n(),
    percentage = 100,                
    meanCholesterol = round(mean(cholesterolNumeric, na.rm = TRUE), 2),
    medianCholesterol = round(median(cholesterolNumeric, na.rm = TRUE), 2),
    sdCholesterol = round(sd(cholesterolNumeric, na.rm = TRUE), 2),
    Q1_Cholesterol = round(quantile(cholesterolNumeric, 0.25, na.rm = TRUE), 2),
    Q3_Cholesterol = round(quantile(cholesterolNumeric, 0.75, na.rm = TRUE), 2),
    iqrCholesterol = round(IQR(cholesterolNumeric, na.rm = TRUE), 2)
  )

descCholesterol <- bind_rows(descCholesterol, overallCholesterol)

# Print table
print(descCholesterol)

# Prepare filtered data for plotting
numCholesterol_filtered <- descCholesterol %>%
  filter(numCholesterol != "Overall") %>%
  mutate(numCholesterol = factor(numCholesterol, levels = c("<5.0", "5.0-5.5", "5.6-6.0", "≥6.0")))

# Plot cholesterol levels by gender
ggplot(numCholesterol_filtered, aes(x = numCholesterol, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Cholesterol Categories by Gender (%)",
    x = "Cholesterol Level (mmol/L)",
    y = "Percentage (%)",
    fill = "Gender"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(hjust = 0.5),  
    legend.position = "right", 
    plot.title = element_text(hjust = 0.5, margin = margin(b = 30)),
    plot.margin = margin(b = 30, t = 20, r = 20, l = 20)
  )

```

```{r desc stat BLOOD GLUCOSE , echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
set.seed(123)
dataGlucose <- msmData %>%
  mutate(
    numGlucose = case_when(
      glucose == "less.than.5.5" ~ "<5.0",         #normal
      glucose == "5.5.to.7.0" ~ "5.0-7",           #prediabetes
      glucose == "greater.than.7.0" ~ "≥7.0",      #diabetes
      TRUE ~ glucose
    ),
   glucoseNumeric = case_when(
      glucose == "less.than.5.5" ~ runif(n(), min = 4, max = 5.5),
      glucose == "5.5.to.7.0"~ runif(n(), min = 5.5, max = 7.0),
      glucose == "greater.than.7.0" ~ runif(n(), min =7.0 , max = 9),
      TRUE ~ as.numeric(glucose)
    )
  )

descGlucose <- dataGlucose %>%
  group_by(numGlucose, gender) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(dataGlucose)) * 100, 2),
    meanGlucose = round(mean(glucoseNumeric, na.rm = TRUE), 2),
    medianGlucose = round(median(glucoseNumeric, na.rm = TRUE), 2),
    sdGlucose = round(sd(glucoseNumeric, na.rm = TRUE), 2),
    Q1_Glucose = round(quantile(glucoseNumeric, 0.25, na.rm = TRUE), 2),
    Q3_Glucose= round(quantile(glucoseNumeric, 0.75, na.rm = TRUE), 2),
    iqrGlucose = round(IQR(glucoseNumeric, na.rm = TRUE), 2),
    .groups = 'drop'
  )

overallGlucose <- dataGlucose %>%
  summarise(
    numGlucose = "Overall",             
    gender = "All",                   
    count = n(),
    percentage = 100,                
    meanGlucose= round(mean(glucoseNumeric, na.rm = TRUE), 2),
    medianGlucose = round(median(glucoseNumeric, na.rm = TRUE), 2),
    sdGlucose= round(sd(glucoseNumeric, na.rm = TRUE), 2),
    Q1_Glucose= round(quantile(glucoseNumeric, 0.25, na.rm = TRUE), 2),
    Q3_Glucose = round(quantile(glucoseNumeric, 0.75, na.rm = TRUE), 2),
    iqrGlucose = round(IQR(glucoseNumeric, na.rm = TRUE), 2)
  )

descGlucose <- bind_rows(descGlucose, overallGlucose)

# print table
print(descGlucose)

#prepare for plotting
numGlucose_filtered <- descGlucose %>%
  filter(numGlucose != "Overall") %>%
  mutate(numGlucose = factor(numGlucose, levels = c("<5.0", "5.0-7", "≥7.0")))

# chart: blood glucose
ggplot(numCholesterol_filtered, aes(x = numCholesterol, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Blood glucose Categories by Gender (%)",
    x = "Blood glucose level (mmol/L)",
    y = "Percentage (%)",
    fill = "Gender"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(hjust = 0.5),  
    legend.position = "right", 
    plot.title = element_text(hjust = 0.5, margin = margin(b = 30)),
    plot.margin = margin(b = 30, t = 20, r = 20, l = 20)
  )

```

```{r desc stat HBA1C , echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
set.seed(123)
dataHba1c<- msmData %>%
  mutate(
    numHba1c = case_when(
      hba1c == "less.than.42" ~ "<42",         #normal
      hba1c == "42.to.48" ~ "42-48",           #prediabetes
      hba1c  == "greater.than.48" ~ "≥48",      #diabetes
      TRUE ~ hba1c
    ),
   hba1cNumeric = case_when(
      hba1c  == "less.than.42"~ runif(n(), min = 36, max = 42),
      hba1c  == "42.to.48"~ runif(n(), min = 42, max = 48),
      hba1c == "greater.than.48" ~ runif(n(), min =48 , max = 54),
      TRUE ~ as.numeric(hba1c)
    )
  )

descHba1c  <- dataHba1c %>%
  group_by(numHba1c, gender) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(dataHba1c)) * 100, 2),
    meanHba1c= round(mean(hba1cNumeric, na.rm = TRUE), 2),
    medianHba1c = round(median(hba1cNumeric, na.rm = TRUE), 2),
    sdHba1c= round(sd(hba1cNumeric, na.rm = TRUE), 2),
    Q1_Hba1c = round(quantile(hba1cNumeric, 0.25, na.rm = TRUE), 2),
    Q3_Hba1c= round(quantile(hba1cNumeric, 0.75, na.rm = TRUE), 2),
    iqrHba1c= round(IQR(hba1cNumeric, na.rm = TRUE), 2),
    .groups = 'drop'
  )

overallHba1c <- dataHba1c %>%
  summarise(
    numHba1c = "Overall",             
    gender = "All",                   
    count = n(),
    NA_count = sum(is.na(hba1cNumeric)),
    percentage = 100,                
    meanHba1c= round(mean(hba1cNumeric, na.rm = TRUE), 2),
    medianHba1c = round(median(hba1cNumeric, na.rm = TRUE), 2),
    sdHba1c= round(sd(hba1cNumeric, na.rm = TRUE), 2),
    Q1_Hba1c = round(quantile(hba1cNumeric, 0.25, na.rm = TRUE), 2),
    Q3_Hba1c= round(quantile(hba1cNumeric, 0.75, na.rm = TRUE), 2),
    iqrHba1c= round(IQR(hba1cNumeric, na.rm = TRUE), 2),
  )

descHba1c <- bind_rows(descHba1c, overallHba1c)

# print table
print(descHba1c)

#prepare for plotting
numHba1c_filtered <- descHba1c %>%
  filter(numHba1c != "Overall") %>%
  mutate(numHba1c = factor(numHba1c, levels = c("<42", "42-48", "≥48")))

# chart: blood glucose
ggplot(numHba1c_filtered, aes(x = numHba1c, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Hba1c level by gender (%)",
    x = "Hba1c level (mmol/L)",
    y = "Percentage (%)",
    fill = "Gender"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(hjust = 0.5),  
    legend.position = "right", 
    plot.title = element_text(hjust = 0.5, margin = margin(b = 30)),
    plot.margin = margin(b = 30, t = 20, r = 20, l = 20)
  )

```






#Starting Cox
```{r PREPARE COX , echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
#################################################################################
# Experimental code to run Cox for continuous covariates
################################################################################

# So we don't forget to load the other files
source("Biomarkers.R")
source("SurvivalAnalysis.R")


# Operates on a specified transition given a covariate list and the
# wideTransitionTableContSub
runContinuousCox <- function(wideTransitionTable, covariates, transition) {

    wideTransitionTable <- convertNAsToFalse(wideTransitionTable)
    
    # Step 1: Prepare data in long format using prepareDataForModel (from SurvivalAnalysis.R)
    preparedData <- prepareDataForModel(transitionMatrix, wideTransitionTable, covariateList = covariates)
    
    # Step 2: Add age if necessary
    if ("age" %in% covariates) {
        preparedData <- addContinuousTimeDependentAge(preparedData, wideTransitionTable)
    }
    
    # Step 3: Extract only the data for the given transition
    message(glue("Fitting model for transition: {transition} and covariates: {paste(covariates, collapse = ', ')}"))
    setDT(preparedData)
    preparedData <- preparedData[trans == transition]
    filteredData <- as.data.frame(preparedData)
    gc() 
    rm(preparedData)
    rm(wideTransitionTable)
    gc()

    # Step 4: Construct model representing Cox survival function
    formula <- as.formula(paste("Surv(Tstart, Tstop, status) ~", paste(covariates, collapse = " + ")))
    
    # Remove factors (categorical data needs factors)
    for (cov in covariates) {
      if (is.factor(filteredData[[cov]])) {
        filteredData[[cov]] <- as.numeric(as.character(filteredData[[cov]]))
      }
    }

    # Step 5: Fit Cox model with the expanded covariates
    filteredData$bmi <- round(filteredData$bmi, 1)
    coxModel <- coxph(formula, data = filteredData, x = TRUE, method = "breslow")
    
    # Get summary and round coefficients and confidence intervals
    summaryModelCox <- summary(coxModel)
    coefs <- summaryModelCox$coefficients
    coefs <- round(coefs, 3)
    
    # Add confidence intervals
    confInterval<- round(confint(coxModel), 3)
    
    # Combine coefficients with confidence intervals
    resultValueCox <- data.frame(
        Estimate = round(coefs[, "coef"],3),
        `Hazard Ratio` = round(exp(coefs[, "coef"]),3),
        `Std. Error` = round(coefs[, "se(coef)"], 3),
        `z value` = round(coefs[, "z"], 3),
        `Pr(>|z|)` = round(coefs[, "Pr(>|z|)"], 3),
        `Lower CI` = round(confInterval[, 1], 3),
        `Upper CI` = round(confInterval[, 2], 3)
    )
    
   return(list(results = resultValueCox, model = coxModel))
}
    


addContinuousTimeDependentAge <- function(msdata, wideTransitionTable) {
  # Merge the age from wideTransitionTable into msdata based on patid
  # Assuming 'age' is the baseline age in wideTransitionTable

  # Calculate age at each Tstart (in years) and store it as the updated age
  msdata$age <- msdata$age + (msdata$Tstart / 365.25)
  
  # Clean up intermediate columns if not needed
  if ("age_at_Tstart" %in% names(msdata)) {
    msdata <- msdata[, !names(msdata) %in% c("age_at_Tstart")]
  }
  
  return(msdata)
}

```

```{r TRANSITION MATRIX, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
# Re-visit transition matrix
print(transitionMatrix)

```

```{r TESTING, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
covariatesChosen <- c("age", "gender", "deprivationIndex", "diabetesFH", "cvdFH", 
                      "bmi", "hdl", "triglycerides", "cholesterol", 
                      "glucose", "sbp", "latestSmokingStatus", "alcoholStatus", 
                      "atrialFib", "hyperlipidaemia")

# Initialize list to store results
listResult <- list()

# Loop through transitions
for (i in 1:13) {  
    resultCox <- runContinuousCox(wideTransitionTableContSub, covariatesChosen, i)
    listResult[[i]] <- resultCox$results

    # Create a table for each transition and print it with a header
    cat(paste("\n### Transition", i, "Results\n"))  # Markdown header
    print(kable(resultCox$results, digits = 3) %>% kable_styling(full_width = FALSE))
} 
```

```{r TESTING, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
covariatesChosen <- c("age", "gender", "deprivationIndex", "diabetesFH", "cvdFH", 
                      "bmi", "hdl", "triglycerides", "cholesterol", 
                      "glucose", "sbp", "latestSmokingStatus", "alcoholStatus", 
                      "atrialFib", "hyperlipidaemia")

# Initialize list to store results
listResult <- list()

# Loop through transitions
for (i in 1:13) {  
    resultCox <- runContinuousCox(wideTransitionTableContSub, covariatesChosen, i)
    listResult[[i]] <- resultCox$results
hazardDF <- data.frame(
    Covariate = rownames(resultCox$results),
    Hazard_Ratio = exp(resultCox$results[["Estimate"]]),
    Lower_CI = exp(resultCox$results[["Lower_CI"]]),
    Upper_CI = exp(resultCox$results[["Upper_CI"]]),
    Transition = i
)

  # Append results to the list
  results[[i]] <- hazardDF
  
  # Plotting
ggplot(final_results, aes(x = Covariate, y = Hazard_Ratio, ymin = Lower_CI, ymax = Upper_CI)) +
  geom_point() +
  geom_errorbar(width = 0.2) +
  facet_wrap(~ Transition) +
  scale_y_log10() +  # Log scale for hazard ratios
  labs(title = "Overall Hazard Ratios by Transition",
       x = "Covariates",
       y = "Hazard Ratio (Log Scale)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
}
```



```{r TESTING, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE} 

str(resultCox)
# Define covariates (just prevent to re-run above code)
covariatesChosen <- c("age", "gender", "deprivationIndex", "diabetesFH", "cvdFH", 
                      "bmi", "hdl", "triglycerides", "cholesterol", 
                      "glucose", "sbp", "latestSmokingStatus", "alcoholStatus", 
                      "atrialFib", "hyperlipidaemia")

# Initialise list to store Schoenfeld plots
schoenfeldResults <- data.frame()

# Loop through transitions
for (i in 1:13) {  
    resultScho <- runContinuousCox(wideTransitionTableContSub, covariatesChosen, i)

    # Perform Schoenfeld residuals test
    schoenfeldTest <- cox.zph(resultScho$model)

    # Print Schoenfeld residuals test results with formatted p-values
    cat("\n### Schoenfeld Residuals Test for Transition", i, "\n")
    
    # Extract statisticc test
    chiSQ <- round(schoenfeldTest $table[, "chisq"], 3)
    pVal <- round( schoenfeldTest $table[, "p"], 3)
    
    # Display results
    allresultSchoenfeld<- data.frame(
        Variable = rownames(schoenfeldTest$table),
        Chi_Square = chiSQ,
        P_Value = pVal,
        Transition = i
    )
    print(allresultSchoenfeld)
}  


```

```{r TESTING, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE} 
# Create plot for each covariate
    plot <- ggcoxzph(schoenfeld_test, variable = covariate) +
      labs(title = paste("Transition", i, "- Schoenfeld Residuals for", covariate),
           x = "Time (years)",
           y = "Schoenfeld Residuals") +
      scale_x_continuous(breaks = seq(0, max(schoenfeld_test$y, na.rm = TRUE), by = 5))  # Adjust breaks

    # Add transition number as a prefix to the plot title for identification
    plot <- plot + theme(plot.title = element_text(hjust = 0.5))  # Center the title

    # Store the plot in the list
    schoenfeld_plots[[paste("Transition", i, covariate)]] <- plot
  }
}

# Combine all plots into a single facet plot
facet_plot <- ggpubr::ggarrange(plotlist = schoenfeld_plots, ncol = 2, nrow = ceiling(length(schoenfeld_plots) / 2))

# Display the combined facet plot
print(facet_plot)