---
title: "Descriptive Statistic"
author: "Septiara Putri"
date: "2024-08-30"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Description 
This is a descriptive statistic and multistate model analysis using CPRD Aurum data.
State transition model (STM) consists of several states representing cardiometabolic disease (CMD) progression. The structure of model is published at:  https://bmchealthservres.biomedcentral.com/articles/10.1186/s12913-024-11559-y. 
States: disease free, type 2 diabetes (T2DM), Stroke, MI, Post-stroke, Post-MI, Death

```{r set the working directory, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
setwd("/Users/septiaraputri/Desktop/RParquet/PrepareAurumData")
msmData<-read.csv("/Users/septiaraputri/Desktop/RParquet/PrepareAurumData/wideTransitionTableContSub.csv")
```

```{r load library, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
library(data.table)
library(dplyr)
library(knitr)
library(ggplot2)
library(mstate)
library(tidyr)
```



# Non-modifiable risks factors
```{r desc stat AGE, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
# Specify age group, summary statistic
msmData <-msmData %>%
  mutate(ageGroup = cut(age, breaks =c(0, 18, 30, 45, 60, 75, Inf),
                         labels = c("<18","18-29","30-44","45-59","60-74", "≥75"),
                         right=FALSE))

descAge <-msmData %>%
  group_by(ageGroup, gender) %>%
  summarise(
    count = n(),
    percentage = round((n()/nrow(msmData))*100,2),
    meanAge = round(mean (age, na.rm=TRUE), 2),
    medianAge = round(median(age, na.rm=TRUE), 2),
    sdAge = round(sd(age, na.rm = TRUE), 2),
    Q1_Age = round(quantile(age, 0.25, na.rm = TRUE), 2),   
    Q3_Age = round(quantile(age, 0.75, na.rm = TRUE), 2),   
    iqrAge = round(IQR(age, na.rm = TRUE), 2),
    minAge = round(min(age, na.rm = TRUE), 2),  
    maxAge = round(max(age, na.rm = TRUE), 2), 
    .groups = 'drop'
    
  ) 

# Print table
print(descAge)

# Plot by gender
# Bar plot
barPlot_age<-ggplot(descAge, aes(x = ageGroup, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Age",
       x = "Age group",
       y = "Percentage (%)",
       fill = "Gender") +
  theme_grey() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, face="bold"),  
    axis.title.x = element_text(size = 10, margin = margin(t=10)), 
    axis.title.y = element_text(size = 10),  
    axis.text.x = element_text(angle = 360, hjust = 0.5, size = 8),  
    axis.text.y = element_text(size = 8)  
  ) +
  scale_fill_brewer(palette = "Set1")
  print(barPlot_age)
 
# Box plot 
boxPlot_age <- ggplot(msmData, aes(x = gender, y = age, fill = gender)) +
  geom_boxplot(outlier.color = "red", outlier.shape = 14, alpha = 0.7) +
  scale_y_continuous(name = "Age") +
  scale_x_discrete(name = "Gender") +
  labs(
    title = "Age Distribution",
    fill = "Gender"
  ) +
  theme_grey() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, face="bold"),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(size = 8),
    axis.text.y = element_text(size = 8)
  ) +
  scale_fill_brewer(palette = "Set1")
  print(boxPlot_age)

```


```{r desc stat GENDER, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
# Summary statistic
msmData$gender<-as.factor(msmData$gender)
descGender <-msmData %>%
  group_by(gender) %>%
  summarise(
    count = n(),
    percentage = round((n()/nrow(msmData))*100,2),
)

# Print table 
print(descGender)
```


```{r desc stat IMD, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
# Summary statistic 
descDeprivation <- msmData %>%
  group_by(deprivationIndex, gender) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(msmData)) * 100, 2),
  )

# Print table
print(descDeprivation)

# Plot IMD, 1=most deprived and 5=least deprived
# Bar plot
barPlot_imd <- ggplot(descDeprivation, aes(x = deprivationIndex, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +  
  labs(
    title = "Deprivation Level",
    x = "Deprivation Level (1 = most deprived 5 = least deprived)",
    y = "Percentage (%)",
    fill = "Gender"
  ) +
  theme_grey() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size=10, face="bold"),
    axis.title.x = element_text(size = 10, margin = margin(t=10)), 
    axis.title.y = element_text(size = 10),  
    axis.text.x = element_text(angle = 360, hjust = 0.5, size = 8),  
    axis.text.y = element_text(size = 8) 
  ) +
  scale_fill_brewer(palette = "Set1")
  print(barPlot_imd)

# Box plot  
boxPlot_imd <- ggplot(msmData, aes(x = factor(deprivationIndex), y = age, fill = gender)) +
  geom_boxplot(outlier.color = "red", outlier.shape = 14, alpha = 0.7) +
  labs(
    title = "Age Distribution by Deprivation Level and Gender",
    x = "Deprivation Level (1 = most deprived 5 = least deprived)",
    y = "Age",
    fill = "Gender"
  ) +
  theme_grey() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, face="bold"),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(size = 8),
    axis.text.y = element_text(size = 8),
    legend.position = "right"
  ) +
  scale_fill_brewer(palette = "Set1")

# Print box plot
print(boxPlot_imd)


```


```{r desc stat ETHNICITY, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
# Summary statistic, 5 ethnic group
descEthnicity <- msmData %>%
  group_by(ethnicity = addNA(as.factor(ethnicity)), gender) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(msmData)) * 100, 2),
)

# Print table 
print(descEthnicity)

#Reorder
library(forcats)

# Reorder ethnicity by percentage
# Reorder ethnicity by total percentage across genders
descEthnicity <- descEthnicity %>%
  group_by(ethnicity) %>%
  mutate(total_percentage = sum(percentage)) %>%  # Calculate total percentage
  ungroup() %>%
  mutate(ethnicity = fct_reorder(ethnicity, total_percentage, .desc = TRUE))


# Plot 
barPlot_ethnicity <- ggplot(descEthnicity, aes(x = ethnicity, y = percentage, fill = gender)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Ethnicity",
    x = "Ethnicity",
    y = "Percentage (%)",
    fill = "Gender"
  ) +
  theme_grey() +
  theme(
     plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, face="bold"),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(size = 8),
    axis.text.y = element_text(size = 8),
    legend.position = "right"
  ) +
  scale_fill_brewer(palette = "Set1")
  print(barPlot_ethnicity)
```


```{r desc stat ALCOHOL, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
# Summary statistic alcohol level
# Level 0>>>0 unit/week, non-drinker)
# Level 1>>>up to 14 unit/week, low consumption)
# Level 2>>>5-35/week, moderate consumption)
# Level 3>>>>35 unit/week, high consumption)

# Summarise alcoholStatus by gender
descAlcohol <- msmData %>%
  group_by(alcoholStatus, gender) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(msmData)) * 100, 2),
    .groups = "drop"
  )

# Print table
print(descAlcohol)

# Plot 
barPlot_alcoholstat <- ggplot(descAlcohol %>% filter(!is.na(alcoholStatus)), aes(x = alcoholStatus, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Alcohol Consumption Level",
    x = "Alcohol Consumption Level",
    y = "Percentage (%)",
    fill = "Gender"
  ) +
  theme_grey() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, face="bold"),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(angle = 360, hjust = 0.5, size = 8),
    axis.text.y = element_text(size = 8),
    legend.position = "right"
  ) +
  scale_x_discrete(labels = c(
    "AlcoholConsumptionLevel0" = "Level 0",
    "AlcoholConsumptionLevel1" = "Level 1",
    "AlcoholConsumptionLevel2" = "Level 2",
    "AlcoholConsumptionLevel3" = "Level 3",
    "Unknown" = "Unknown"
  )) +  # Change labels for the x-axis
  scale_fill_brewer(palette = "Set1")

print(barPlot_alcoholstat)

```


```{r desc stat SMOKING, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
# Summary statistic : latest smoking status
descSmoking <- msmData %>%
  group_by(latestSmokingStatus, gender) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(msmData)) * 100, 2)
  )

# Print table
print(descSmoking)

# Plot
barPlot_smokingstat <- ggplot(descSmoking, aes(x = latestSmokingStatus, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Latest Smoking Status",
    x = "Smoking Status",
    y = "Percentage (%)",
    fill = "Gender"
  ) +
  theme_grey() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, face="bold"),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(size = 8),
    axis.text.y = element_text(size = 8),
    legend.position = "right"
  ) +
  scale_fill_brewer(palette = "Set1")

print(barPlot_smokingstat)
```


```{r desc stat FAMILY HISTORY, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
# Summary statistic family history: diabetes, CVD
longFH<- msmData %>%
  pivot_longer(cols=c(cvdFH, diabetesFH),
  names_to = "FamilyHistory",
  values_to = "status")

descFH<-longFH %>%
  group_by(FamilyHistory, status= addNA(as.factor(status)), gender) %>%
  summarise(
    count = n(),  
    percentage = round((n() / nrow(msmData)) * 100, 2)
)

# Print table
print(descFH)


# Only confirmed disease
descFH_filtered <- descFH %>%
  filter(status == "TRUE")

# Plot
barPlot_FH <- ggplot(descFH_filtered, aes(x = FamilyHistory, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Family History",
    x = "Family History",
    y = "Percentage (%)",
    fill = "Gender"
  ) +
  theme_grey() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, face="bold"),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(size = 8),
    axis.text.y = element_text(size = 8),
    legend.position = "right"
  ) +
  scale_fill_brewer(palette = "Set1")

print(barPlot_FH)


```


```{r desc stat PRESENCE DAIGNOSIS, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
# Summary statistic AF, hyperlipidaemia, hypertension

longPDS<- msmData %>%
  pivot_longer(
    cols=c(atrialFib, hyperlipidaemia, hypertension),
    names_to = "previousDiagnosis",
    values_to = "status"
    )
 
descPDS <- longPDS %>%
  group_by(previousDiagnosis, status = as.factor(status), gender) %>%
  summarise(
    count = n(),  
    percentage = round((n() / nrow(msmData)) * 100, 2),
    .groups = 'drop'
  )

# Print table
print(descPDS)


# Only confirmed diagnosis
descPDS_filtered <- descPDS %>%
  filter(status == "TRUE")

# Plot
barPlot_PDS <-ggplot(descPDS_filtered, aes(x = previousDiagnosis, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +  
  labs(
    title = "Presence Diagnosis",
    x = "Condition",
    y = "Percentage (%)",
    fill = "Gender"
  ) +
  theme_grey() +
   theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, face="bold"),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(size = 8),
    axis.text.y = element_text(size = 8),
    legend.position = "right"
  ) +
  scale_fill_brewer(palette = "Set1")

print(barPlot_PDS)

```


```{r ALL VISUAL NMD, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE, fig.width=16, fig.height=14}

combinedBarPlot_NMD<- barPlot_age + barPlot_imd + barPlot_alcoholstat + barPlot_smokingstat + barPlot_ethnicity + barPlot_FH + barPlot_PDS +
  plot_layout(ncol = 3) +    
  plot_annotation(title = "Non-modifiable Risk Factor") 

print(combinedBarPlot_NMD)
```




#Modifiable risk factors
```{r desc stat BMI, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
set.seed(123)

# Summary statistic 
# <18.5 (underweight)
# 18.5- 24.9 (normal weight)
# 25- 29.9 (moderate)
# ≥30 (obese)

msmData$bmi <- as.numeric(as.character(msmData$bmi))
msmData <- msmData %>%
  mutate(
    bmiCat = cut(
      bmi,  
      breaks = c(-Inf, 18.5, 24.9, 29.9, Inf),  
      labels = c("<18.5", "18.5-24.9", "25-29.9", "≥30"),  
      right = TRUE  
    )
  )


# Summary statistic for BMI categories by gender
descBMI <- msmData %>%
  group_by(bmiCat, gender) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(msmData)) * 100, 2),
    meanBMI = round(mean(bmi, na.rm = TRUE), 2),
    medianBMI = round(median(bmi, na.rm = TRUE), 2),
    sdBMI = round(sd(bmi, na.rm = TRUE), 2),
    Q1_BMI = round(quantile(bmi, 0.25, na.rm = TRUE), 2),   
    Q3_BMI = round(quantile(bmi, 0.75, na.rm = TRUE), 2),   
    iqrBMI = round(IQR(bmi, na.rm = TRUE), 2), 
    minBMI = round(min(bmi, na.rm = TRUE), 2),  
    maxBMI = round(max(bmi, na.rm = TRUE), 2), 
    .groups = 'drop'
  )

# Print table
print(descBMI)

# Bar plot for BMI categories by gender
barPlot_bmi <- ggplot(descBMI, aes(x = bmiCat, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +  
  labs(
    title = "Body Mass Index (BMI)",
    x = "BMI Category (kg/m²)",
    y = "Percentage (%)",
    fill = "Gender"
  ) +
  theme_grey() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, face="bold"),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(angle = 360, hjust = 0.5, size = 8), 
    axis.text.y = element_text(size = 8),
    legend.position = "right"
  ) +
  scale_fill_brewer(palette = "Set1")

print(barPlot_bmi)

# Box plot 
# Box plot for BMI distribution by gender and category
boxPlot_bmi <- ggplot(msmData, aes(x = gender, y = bmi, fill = gender)) +
  geom_boxplot(outlier.color = "red", outlier.shape = 14, alpha = 0.7) +
  labs(
    title = "Body Mass Index (BMI)",
    x = "Gender",
    y = "BMI Value",
    fill = "Gender"
  ) +
  theme_grey() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, face="bold"),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(angle = 360, hjust = 0.5, size = 8),
    axis.text.y = element_text(size = 8),
    legend.position = "right"
  ) +
  scale_fill_brewer(palette = "Set1")

# Print box plot
print(boxPlot_bmi)

```

```{r desc stat HDL, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

# HDL level : 
# low >>> higher risk of CMD
# borderline >>> adequate
# high >>> protective

set.seed(123)

msmData$hdl <-as.numeric(as.character(msmData$hdl))
  msmData <-msmData %>%
    mutate(
      hdlCat = cut(
        hdl,
        breaks = c(-Inf, 1.03, 1.54, Inf),
        labels = c("<1.03", "1.03-1.54", "≥1.55"),
        right = TRUE
      )
    )
      
descHDL <- msmData %>%
  group_by(hdlCat, gender) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(msmData)) * 100, 2),
    meanHDL = round(mean(hdl, na.rm = TRUE), 2),
    medianHDL = round(median(hdl, na.rm = TRUE), 2),
    sdHDL = round(sd(hdl, na.rm = TRUE), 2),
    Q1_HDL = round(quantile(hdl, 0.25, na.rm = TRUE), 2),   # First quartile (Q1)
    Q3_HDL = round(quantile(hdl, 0.75, na.rm = TRUE), 2),   # Third quartile (Q3)
    iqrHDL = round(IQR(hdl, na.rm = TRUE), 2),              # Interquartile Range (IQR)
    minHDL = round(min(hdl, na.rm = TRUE), 2),
    maxHDL = round(max(hdl, na.rm = TRUE), 2),
    .groups = 'drop'
  )


# Print table
print(descHDL)

# Bar plot
barPlot_hdl <- ggplot(descHDL, aes(x = hdlCat, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "High-density lipoprotein (HDL) cholesterol",
    x = "HDL level (mmol/l)",
    y = "Percentage (%)",
    fill = "Gender"
  ) +
   theme_grey() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, face="bold"),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(angle = 360, hjust = 0.5, size = 8),
    axis.text.y = element_text(size = 8),
    legend.position = "right"
  ) +
  scale_fill_brewer(palette = "Set1")

#Print bar plot
print (barPlot_hdl)

#Box plot
boxPlot_hdl <- ggplot(msmData, aes(x = hdlCat, y = hdl, fill = gender)) +
  geom_boxplot(outlier.color = "red", outlier.shape = 14, alpha = 0.7) +
  labs(
    title = "High-density lipoprotein (HDL) cholesterol",
    x = "HDL Category (mmol/l)",
    y = "HDL Value",
    fill = "Gender"
  ) +
  theme_grey() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, "bold"),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(angle = 360, hjust = 0.5, size = 8),
    axis.text.y = element_text(size = 8),
    legend.position = "right"
  ) +
  scale_fill_brewer(palette = "Set1")

# Print box plot
print(boxPlot_hdl)

```

```{r desc stat LDL, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

# LDL category
# <2.6 >>> Low risk
# 2.6-3.3 >>> Borderline risk
# 3.4-3.9 >>> Moderate
# 4.0-4.9 >>> High risk
# ≥ 5.0 >>> very high risk

set.seed(123)


msmData$ldl <-as.numeric(as.character(msmData$ldl))
  msmData <-msmData %>%
    mutate(
      ldlCat = cut(
        ldl,
        breaks = c(-Inf, 2.6, 3.3, 3.9, 4.9, 5.0, Inf),
        labels = c("<2.6", "2.6-3.3", "3.4-3.9", "4.0-4.9", "4.0-4.9", "≥5.0"),
        right = TRUE
      )
    )
  
descLDL <- msmData %>%
  group_by(ldlCat, gender) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(msmData)) * 100, 2),
    meanLDL = round(mean(ldl, na.rm = TRUE), 2),
    medianLDL = round(median(ldl, na.rm = TRUE), 2),
    sdLDL = round(sd(ldl, na.rm = TRUE), 2),
    Q1_LDL = round(quantile(ldl, 0.25, na.rm = TRUE), 2),   # First quartile (Q1)
    Q3_LDL = round(quantile(ldl, 0.75, na.rm = TRUE), 2),   # Third quartile (Q3)
    iqrLDL = round(IQR(ldl, na.rm = TRUE), 2),              # Interquartile Range (IQR)
    minLDL = round(min(ldl, na.rm = TRUE), 2),
    maxLDL = round(max(ldl, na.rm = TRUE), 2),
    .groups = 'drop'
  )

# Print table
print(descLDL)

# Bar plot
barPlot_ldl <- ggplot(descLDL, aes(x = ldlCat, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Low-density lipoprotein (LDP) cholesterol",
    x = "LDL level (mmol/l)",
    y = "Percentage (%)",
    fill = "Gender"
  ) +
   theme_grey() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, face = "bold"),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(angle = 360, hjust = 0.5, size = 8),
    axis.text.y = element_text(size = 8),
    legend.position = "right"
  ) +
  scale_fill_brewer(palette = "Set1")

#Print bar plot
print (barPlot_ldl)

#Box plot
boxPlot_ldl <- ggplot(msmData, aes(x = ldlCat, y = ldl, fill = gender)) +
  geom_boxplot(outlier.color = "red", outlier.shape = 14, alpha = 0.7) +
  labs(
    title = "Low-density lipoprotein (LDP) cholesterol",
    x = "LDL Category (mmol/l)",
    y = "LDL Value",
    fill = "Gender"
  ) +
  theme_grey() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, face="bold" ),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(angle = 360, hjust = 0.5, size = 8),
    axis.text.y = element_text(size = 8),
    legend.position = "right"
  ) +
  scale_fill_brewer(palette = "Set1")

# Print box plot
print(boxPlot_ldl)

```

```{r desc stat SBP, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

# SBP level
# <120 >>> normal
# 120-140 >>> elevated 
# ≥140 >>> hypertension

set.seed(123)


msmData$sbp <-as.numeric(as.character(msmData$sbp))
  msmData <-msmData %>%
    mutate(
      sbpCat = cut(
        sbp,
        breaks = c(-Inf, 120, 140, Inf),
        labels = c("<120", "120-139", "≥140"),
        right = TRUE
      )
    )
  
descSBP <- msmData %>%
  group_by(sbpCat, gender) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(msmData)) * 100, 2),
    meanSBP = round(mean(sbp, na.rm = TRUE), 2),
    medianSBP = round(median(sbp, na.rm = TRUE), 2),
    sdSBP = round(sd(sbp, na.rm = TRUE), 2),
    Q1_SBP = round(quantile(sbp, 0.25, na.rm = TRUE), 2),   # First quartile (Q1)
    Q3_SBP = round(quantile(sbp, 0.75, na.rm = TRUE), 2),   # Third quartile (Q3)
    iqrSBP = round(IQR(sbp, na.rm = TRUE), 2),              # Interquartile Range (IQR)
    .groups = 'drop'
  )

# Print table
print(descSBP)

# Bar plot
barPlot_sbp <- ggplot(descSBP, aes(x = sbpCat, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Systolic Blood Pressure (SBP)",
    x = "SBP level (mmHg)",
    y = "Percentage (%)",
    fill = "Gender"
  ) +
   theme_grey() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, face="bold"),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(angle = 360, hjust = 0.5, size = 8),
    axis.text.y = element_text(size = 8),
    legend.position = "right"
  ) +
  scale_fill_brewer(palette = "Set1")

#Print bar plot
print (barPlot_sbp)

#Box plot
boxPlot_sbp <- ggplot(msmData, aes(x = sbpCat, y = sbp, fill = gender)) +
  geom_boxplot(outlier.color = "red", outlier.shape = 14, alpha = 0.7) +
  labs(
    title = "Systolic Blood Pressure (SBP)",
    x = "SBP Category (mmHg)",
    y = "SBP Value",
    fill = "Gender"
  ) +
  theme_grey() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, face="bold"),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(angle = 360, hjust = 0.5, size = 8),
    axis.text.y = element_text(size = 8),
    legend.position = "right"
  ) +
  scale_fill_brewer(palette = "Set1")

# Print box plot
print(boxPlot_sbp)

```

```{r desc stat DBP, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

# DBP level
# <80 >>> normal
# 80-90 >>> elevated
# ≥90 >>> hypertension

set.seed(123)

msmData$dbp <-as.numeric(as.character(msmData$dbp))
  msmData <-msmData %>%
    mutate(
      dbpCat = cut(
        dbp,
        breaks = c(-Inf, 80, 90, Inf),
        labels = c("80", "80-90", "≥90"),
        right = TRUE
      )
    )
  
descDBP <- msmData %>%
  group_by(dbpCat, gender) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(msmData)) * 100, 2),
    meanDBP = round(mean(dbp, na.rm = TRUE), 2),
    medianDBP= round(median(dbp, na.rm = TRUE), 2),
    sdDBP = round(sd(dbp, na.rm = TRUE), 2),
    Q1_DBP = round(quantile(dbp, 0.25, na.rm = TRUE), 2),   # First quartile (Q1)
    Q3_DBP = round(quantile(dbp, 0.75, na.rm = TRUE), 2),   # Third quartile (Q3)
    iqrDBP = round(IQR(dbp, na.rm = TRUE), 2),              # Interquartile Range (IQR)
    minDBP = round(min(dbp, na.rm = TRUE), 2),
    maxDBP = round(max(dbp, na.rm = TRUE),2),
    .groups = 'drop'
  )

# Print table
print(descDBP)

# Bar plot
barPlot_dbp <- ggplot(descDBP, aes(x = dbpCat, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Diastolic Blood Pressure (DBP)",
    x = "DBP level (mmHg)",
    y = "Percentage (%)",
    fill = "Gender"
  ) +
   theme_grey() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, face ="bold"),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(angle = 360, hjust = 0.5, size = 8),
    axis.text.y = element_text(size = 8),
    legend.position = "right"
  ) +
  scale_fill_brewer(palette = "Set1")

#Print bar plot
print (barPlot_dbp)

#Box plot
boxPlot_dbp <- ggplot(msmData, aes(x = gender, y = dbp, fill = gender)) +
  geom_boxplot(outlier.color = "red", outlier.shape = 14, alpha = 0.7) +
  labs(
    title = "Diastolic Blood Pressure (DBP)",
    x = "DBP level (mmHg)",
    y = "DBP Value",
    fill = "Gender"
  ) +
  theme_grey() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, face ="bold"),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(angle = 360, hjust = 0.5, size = 8),
    axis.text.y = element_text(size = 8),
    legend.position = "right"
  ) +
  scale_fill_brewer(palette = "Set1")

# Print box plot
print(boxPlot_dbp)


```

```{r desc stat TRIGLYCERIDES, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

# Triglycerides level
# < 1.7 >>> low-risk
# 1.7-2.2 >>> borderline high
# 2.3-5.6 >>> high
# ≥5.6 >>> very high

set.seed(123)

msmData$triglycerides <-as.numeric(as.character(msmData$triglycerides))
  msmData <-msmData %>%
    mutate(
    triglyceridesCat = cut(
       triglycerides,
        breaks = c(-Inf, 1.7, 2.2, 5.6, Inf),
        labels = c("<1.7", "1.7-2.2", "2.2-5.6", "≥5.6"),
        right = TRUE
      )
    )
  
  
descTriglycerides<- msmData %>%
  group_by(triglyceridesCat, gender) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(msmData)) * 100, 2),
    meanTriglycerides = round(mean(triglycerides, na.rm = TRUE), 2),
    medianTriglycerides = round(median(triglycerides, na.rm = TRUE), 2),
    sdTriglycerides= round(sd(triglycerides , na.rm = TRUE), 2),
    Q1_Triglycerides = round(quantile(triglycerides, 0.25, na.rm = TRUE), 2),
    Q3_Triglycerides = round(quantile(triglycerides, 0.75, na.rm = TRUE), 2),   
    iqrTriglycerides = round(IQR(triglycerides, na.rm = TRUE), 2), 
    minTriglycerides = round(min(triglycerides, na.rm = TRUE), 2), 
    maxTriglycerides = round(max(triglycerides, na.rm = TRUE), 2), 
    .groups = 'drop'
  )


# Print table
print(descTriglycerides)

# Bar plot
barPlot_triglycerides<- ggplot(descTriglycerides, aes(x = triglyceridesCat, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Triglycerides",
    x = "Triglycerides level (mmol/l)",
    y = "Percentage (%)",
    fill = "Gender"
  ) +
   theme_grey() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, face ="bold"),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(angle = 360, hjust = 0.5, size = 8),
    axis.text.y = element_text(size = 8),
    legend.position = "right"
  ) +
  scale_fill_brewer(palette = "Set1")

#Print bar plot
print (barPlot_triglycerides)

#Box plot
boxPlot_triglycerides <- ggplot(msmData, aes(x = gender, y = dbp, fill = gender)) +
  geom_boxplot(outlier.color = "red", outlier.shape = 14, alpha = 0.7) +
  labs(
    title = "Triglycerides",
    x = "Triglycerides level (mmol/l)",
    y = "Triglycerides Value",
    fill = "Gender"
  ) +
  theme_grey() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, face ="bold"),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(angle = 360, hjust = 0.5, size = 8),
    axis.text.y = element_text(size = 8),
    legend.position = "right"
  ) +
  scale_fill_brewer(palette = "Set1")

# Print box plot
print(boxPlot_triglycerides)
  
```

```{r desc stat TOTAL CHOLESTEROL, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

# Total cholesterol level

# <5.0 >>>      Low-risk
# 5.0-5.5 >>>   Borderline high
# 5.6-6.0 >>>   High
# ≥6.0 >>>      Very high


set.seed(123)

msmData$cholesterol <-as.numeric(as.character(msmData$cholesterol))
  msmData <-msmData %>%
    mutate(
   cholesterolCat = cut(
       cholesterol,
        breaks = c(-Inf, 5.0, 5.5, 6.0, Inf),
        labels = c("<5.0", "5.0-5.5", "5.6-6.0", "≥6.0 "),
        right = TRUE
      )
    )

descCholesterol <- msmData %>%
  group_by(cholesterolCat, gender) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(msmData)) * 100, 2),
    meanCholesterol = round(mean(cholesterol, na.rm = TRUE), 2),
    medianCholesterol = round(median(cholesterol, na.rm = TRUE), 2),
    sdCholesterol = round(sd(cholesterol, na.rm = TRUE), 2),
    Q1_Cholesterol = round(quantile(cholesterol, 0.25, na.rm = TRUE), 2),
    Q3_Cholesterol = round(quantile(cholesterol, 0.75, na.rm = TRUE), 2),
    iqrCholesterol = round(IQR(cholesterol, na.rm = TRUE), 2),
    minCholesterol = round(min(cholesterol, na.rm = TRUE), 2),
    maxCholesterol = round(max(cholesterol, na.rm = TRUE), 2),
    .groups = 'drop'
  )


# Print table
print(descCholesterol)


# Plot cholesterol levels by gender
# Bar plot
barPlot_cholesterol<- ggplot(descCholesterol, aes(x = cholesterolCat, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = " Total Cholesterol",
    x = "Cholesterol level (mmol/l)",
    y = "Percentage (%)",
    fill = "Gender"
  ) +
   theme_grey() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, face ="bold"),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(angle = 360, hjust = 0.5, size = 8),
    axis.text.y = element_text(size = 8),
    legend.position = "right"
  ) +
  scale_fill_brewer(palette = "Set1")

#Print bar plot
print (barPlot_cholesterol)

#Box plot
boxPlot_cholesterol <- ggplot(msmData, aes(x = gender, y = cholesterol, fill = gender)) +
  geom_boxplot(outlier.color = "red", outlier.shape = 14, alpha = 0.7) +
  labs(
    title = "Total Cholesterol",
    x = "Cholesterol level (mmol/l)",
    y = "Triglycerides Value",
    fill = "Gender"
  ) +
  theme_grey() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, face ="bold"),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(angle = 360, hjust = 0.5, size = 8),
    axis.text.y = element_text(size = 8),
    legend.position = "right"
  ) +
  scale_fill_brewer(palette = "Set1")

# Print box plot
print(boxPlot_cholesterol)

```

```{r desc stat BLOOD GLUCOSE , echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

# Blood Glucose Level

# <5.0 >>> Normal
# 5.0-7.0 >>> Pre-diabetes
# ≥7.0 >>> Diabetes

set.seed(123)

msmData$glucose <-as.numeric(as.character(msmData$glucose))
  msmData <-msmData %>%
    mutate(
   glucoseCat = cut(
        glucose,
        breaks = c(-Inf, 5.0, 7.0, Inf),
        labels = c("<5.0", "5.0-7.0", "≥7.0 "),
        right = TRUE
      )
    )

descGlucose <- msmData %>%
  group_by(glucoseCat, gender) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(msmData)) * 100, 2),
    meanGlucose = round(mean(glucose, na.rm = TRUE), 2),
    medianGlucose = round(median(glucose, na.rm = TRUE), 2),
    sdGlucose = round(sd(glucose, na.rm = TRUE), 2),
    Q1_Glucose = round(quantile(glucose, 0.25, na.rm = TRUE), 2),
    Q3_Glucose= round(quantile(glucose, 0.75, na.rm = TRUE), 2),
    iqrGlucose = round(IQR(glucose, na.rm = TRUE), 2),
    minGlucose= round(min(glucose, 0.75, na.rm = TRUE), 2),
    maxGlucose = round(max(glucose, na.rm = TRUE), 2),
    .groups = 'drop'
  )


# Print table
print(descGlucose)

# Plot Blood Glucose Level
# Bar plot
barPlot_glucose<- ggplot(descGlucose, aes(x = glucoseCat, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Blood Glucose",
    x = "Blood Glucose Level (mmol/l)",
    y = "Percentage (%)",
    fill = "Gender"
  ) +
   theme_grey() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, face ="bold"),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(angle = 360, hjust = 0.5, size = 8),
    axis.text.y = element_text(size = 8),
    legend.position = "right"
  ) +
  scale_fill_brewer(palette = "Set1")

#Print bar plot
print (barPlot_glucose)

#Box plot
boxPlot_glucose <- ggplot(msmData, aes(x = gender, y = glucose, fill = gender)) +
  geom_boxplot(outlier.color = "red", outlier.shape = 14, alpha = 0.7) +
  labs(
    title = "Blood Glucose",
    x = "Blood Glucose Level (mmol/l)",
    y = "Blood Glucose Value",
    fill = "Gender"
  ) +
  theme_grey() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, face ="bold"),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(angle = 360, hjust = 0.5, size = 8),
    axis.text.y = element_text(size = 8),
    legend.position = "right"
  ) +
  scale_fill_brewer(palette = "Set1")

# Print box plot
print(boxPlot_glucose)

```

```{r desc stat HBA1C , echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

# HbA1c Level
#  <42  >>> Normal
# 42-48 >>> Prediabetes           
# ≥48  >>> Diabetes
  

set.seed(123)

msmData$hba1c <-as.numeric(as.character(msmData$hba1c))
  msmData <-msmData %>%
    mutate(
   hba1cCat = cut(
        hba1c,
        breaks = c(-Inf, 42, 48, Inf),
        labels = c("<42", "42-48", "≥48 "),
        right = TRUE
      )
    )

descHba1c  <- msmData %>%
  group_by(hba1cCat, gender) %>%
  summarise(
    count = n(),
    percentage = round((n() / nrow(msmData)) * 100, 2),
    meanHba1c= round(mean(hba1c, na.rm = TRUE), 2),
    medianHba1c = round(median(hba1c, na.rm = TRUE), 2),
    sdHba1c= round(sd(hba1c, na.rm = TRUE), 2),
    Q1_Hba1c = round(quantile(hba1c, 0.25, na.rm = TRUE), 2),
    Q3_Hba1c= round(quantile(hba1c, 0.75, na.rm = TRUE), 2),
    iqrHba1c= round(IQR(hba1c, na.rm = TRUE), 2),
    minHba1c= round(min(hba1c, na.rm = TRUE), 2),
    maxHba1c= round(max(hba1c, na.rm = TRUE), 2),
    .groups = 'drop'
  )


# Print table
print(descHba1c)

# Plot HbA1c
# Bar plot
barPlot_hba1c<- ggplot(descHba1c, aes(x = hba1cCat, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Hemoglobin A1c (HbA1c)",
    x = "HbA1c Level (mmol/mol)",
    y = "Percentage (%)",
    fill = "Gender"
  ) +
   theme_grey() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, face ="bold"),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(angle = 360, hjust = 2, size = 8),
    axis.text.y = element_text(size = 8),
    legend.position = "right"
  ) +
  scale_fill_brewer(palette = "Set1")

#Print bar plot
print (barPlot_hba1c)

#Box plot
boxPlot_hba1c<- ggplot(msmData, aes(x = gender, y = glucose, fill = gender)) +
  geom_boxplot(outlier.color = "red", outlier.shape = 14, alpha = 0.7) +
  labs(
    title = "Hemoglobin A1c (HbA1c)",
    x = "HbA1c Level (mmol/mol)",
    y = "HbA1c  Value",
    fill = "Gender"
  ) +
  theme_grey() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(b = 10), size = 10, face ="bold"),
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(angle = 360, hjust = 0.5, size = 8),
    axis.text.y = element_text(size = 8),
    legend.position = "right"
  ) +
  scale_fill_brewer(palette = "Set1")

# Print box plot
print(boxPlot_hba1c)

```


```{r ALL VISUAL MD, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE, fig.width=16, fig.height=14}

combinedBarPlot_MD<- barPlot_bmi + barPlot_cholesterol + barPlot_glucose + barPlot_triglycerides + barPlot_hdl + barPlot_ldl + barPlot_sbp + barPlot_dbp + barPlot_hba1c +
  plot_layout(ncol = 3) +    
  plot_annotation(title = "Modifiable Risk Factor") 

print(combinedBarPlot_MD)
```



#Starting Cox
```{r PREPARE COX , echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
#################################################################################
# Experimental code to run Cox for continuous covariates
################################################################################

# So we don't forget to load the other files
source("Biomarkers.R")
source("SurvivalAnalysis.R")


# Operates on a specified transition given a covariate list and the
# wideTransitionTableContSub
runContinuousCox <- function(wideTransitionTable, covariates, transition) {

    wideTransitionTable <- convertNAsToFalse(wideTransitionTable)
    
    # Step 1: Prepare data in long format using prepareDataForModel (from SurvivalAnalysis.R)
    preparedData <- prepareDataForModel(transitionMatrix, wideTransitionTable, covariateList = covariates)
    
    # Step 2: Add age if necessary
    if ("age" %in% covariates) {
        preparedData <- addContinuousTimeDependentAge(preparedData, wideTransitionTable)
    }
    
    # Step 3: Extract only the data for the given transition
    message(glue("Fitting model for transition: {transition} and covariates: {paste(covariates, collapse = ', ')}"))
    setDT(preparedData)
    preparedData <- preparedData[trans == transition]
    filteredData <- as.data.frame(preparedData)
    gc() 
    rm(preparedData)
    rm(wideTransitionTable)
    gc()

    # Step 4: Construct model representing Cox survival function
    formula <- as.formula(paste("Surv(Tstart, Tstop, status) ~", paste(covariates, collapse = " + ")))
    
    # Remove factors (categorical data needs factors)
    for (cov in covariates) {
      if (is.factor(filteredData[[cov]])) {
        filteredData[[cov]] <- as.numeric(as.character(filteredData[[cov]]))
      }
    }

    # Step 5: Fit Cox model with the expanded covariates
    coxModel <- coxph(formula, data = filteredData, x = TRUE, method = "breslow")
    
    # Get summary and round coefficients and confidence intervals
    summaryModelCox <- summary(coxModel)
    coefs <- summaryModelCox$coefficients
    coefs <- round(coefs, 3)
    
    # Add confidence intervals
    confInterval<- round(confint(coxModel), 3)
    
    # Combine coefficients with confidence intervals
    resultValueCox <- data.frame(
        Estimate = round(coefs[, "coef"],3),
        `Hazard Ratio` = round(exp(coefs[, "coef"]),3),
        `Std. Error` = round(coefs[, "se(coef)"], 3),
        `z value` = round(coefs[, "z"], 3),
        `Pr(>|z|)` = round(coefs[, "Pr(>|z|)"], 3),
        `Lower CI` = round(confInterval[, 1], 3),
        `Upper CI` = round(confInterval[, 2], 3)
    )
    
   return(list(results = resultValueCox, model = coxModel))
}
    


addContinuousTimeDependentAge <- function(msdata, wideTransitionTable) {
  # Merge the age from wideTransitionTable into msdata based on patid
  # Assuming 'age' is the baseline age in wideTransitionTable

  # Calculate age at each Tstart (in years) and store it as the updated age
  msdata$age <- msdata$age + (msdata$Tstart / 365.25)
  
  # Clean up intermediate columns if not needed
  if ("age_at_Tstart" %in% names(msdata)) {
    msdata <- msdata[, !names(msdata) %in% c("age_at_Tstart")]
  }
  
  return(msdata)
}

```

```{r TRANSITION MATRIX, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
# Re-visit transition matrix
print(transitionMatrix)

```

```{r TESTING, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
covariatesChosen <- c("age", "gender", "deprivationIndex", "diabetesFH", "cvdFH", 
                      "bmi", "hdl", "triglycerides", "cholesterol", 
                      "glucose", "sbp", "latestSmokingStatus", "alcoholStatus", 
                      "atrialFib", "hyperlipidaemia")

# Initialize list to store results
listResult <- list()

# Loop through transitions
for (i in 1:13) {  
    resultCox <- runContinuousCox(wideTransitionTableContSub, covariatesChosen, i)
    listResult[[i]] <- resultCox$results

    # Create a table for each transition and print it with a header
    cat(paste("\n### Transition", i, "Results\n"))  # Markdown header
    print(kable(resultCox$results, digits = 3) %>% kable_styling(full_width = FALSE))
} 
```

```{r TESTING, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
covariatesChosen <- c("age", "gender", "deprivationIndex", "diabetesFH", "cvdFH", 
                      "bmi", "hdl", "triglycerides", "cholesterol", 
                      "glucose", "sbp", "latestSmokingStatus", "alcoholStatus", 
                      "atrialFib", "hyperlipidaemia")

# Initialize list to store results
listResult <- list()

# Loop through transitions
for (i in 1:13) {  
    resultCox <- runContinuousCox(wideTransitionTableContSub, covariatesChosen, i)
    listResult[[i]] <- resultCox$results
hazardDF <- data.frame(
    Covariate = rownames(resultCox$results),
    Hazard_Ratio = exp(resultCox$results[["Estimate"]]),
    Lower_CI = exp(resultCox$results[["Lower_CI"]]),
    Upper_CI = exp(resultCox$results[["Upper_CI"]]),
    Transition = i
)

  # Append results to the list
  results[[i]] <- hazardDF
  
  # Plotting
ggplot(final_results, aes(x = Covariate, y = Hazard_Ratio, ymin = Lower_CI, ymax = Upper_CI)) +
  geom_point() +
  geom_errorbar(width = 0.2) +
  facet_wrap(~ Transition) +
  scale_y_log10() +  # Log scale for hazard ratios
  labs(title = "Overall Hazard Ratios by Transition",
       x = "Covariates",
       y = "Hazard Ratio (Log Scale)") +
  theme_grey() +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.5))
}
```



```{r TESTING, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE} 

str(resultCox)
# Define covariates (just prevent to re-run above code)
covariatesChosen <- c("age", "gender", "deprivationIndex", "diabetesFH", "cvdFH", 
                      "bmi", "hdl", "triglycerides", "cholesterol", 
                      "glucose", "sbp", "latestSmokingStatus", "alcoholStatus", 
                      "atrialFib", "hyperlipidaemia")

# Initialise list to store Schoenfeld plots
schoenfeldResults <- data.frame()

# Loop through transitions
for (i in 1:13) {  
    resultScho <- runContinuousCox(wideTransitionTableContSub, covariatesChosen, i)

    # Perform Schoenfeld residuals test
    schoenfeldTest <- cox.zph(resultScho$model)

    # Print Schoenfeld residuals test results with formatted p-values
    cat("\n### Schoenfeld Residuals Test for Transition", i, "\n")
    
    # Extract statisticc test
    chiSQ <- round(schoenfeldTest $table[, "chisq"], 3)
    pVal <- round( schoenfeldTest $table[, "p"], 3)
    
    # Display results
    allresultSchoenfeld<- data.frame(
        Variable = rownames(schoenfeldTest$table),
        Chi_Square = chiSQ,
        P_Value = pVal,
        Transition = i
    )
    print(allresultSchoenfeld)
}  


```

```{r TESTING, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE} 
# Create plot for each covariate
    plot <- ggcoxzph(schoenfeld_test, variable = covariate) +
      labs(title = paste("Transition", i, "- Schoenfeld Residuals for", covariate),
           x = "Time (years)",
           y = "Schoenfeld Residuals") +
      scale_x_continuous(breaks = seq(0, max(schoenfeld_test$y, na.rm = TRUE), by = 5))  # Adjust breaks

    # Add transition number as a prefix to the plot title for identification
    plot <- plot + theme(plot.title = element_text(hjust = 0.5))  # Center the title

    # Store the plot in the list
    schoenfeld_plots[[paste("Transition", i, covariate)]] <- plot
  }
}

# Combine all plots into a single facet plot
facet_plot <- ggpubr::ggarrange(plotlist = schoenfeld_plots, ncol = 2, nrow = ceiling(length(schoenfeld_plots) / 2))

# Display the combined facet plot
print(facet_plot)